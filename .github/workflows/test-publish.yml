name: Publish to Test PyPI

on:
  release:
    types: [created]

jobs:
  pypi:
    if: contains(github.event.release.tag_name, '.dev')
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      SETUPTOOLS_SCM_PRETEND_VERSION: ${{ github.event.release.tag_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.release.tag_name }}

      - name: Clean build artefacts
        run: rm -rf dist build ./*.egg-info

      - name: Install dependencies and run tests
        env:
          XAI_ENV: testing
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install .
          pip install pytest
          pytest tests/

      - name: Build package
        run: python3 -m pip install --upgrade build && python3 -m build

      - name: Check version is dev
        run: |
          python -m pip install setuptools_scm
          python - << 'PY'
          from setuptools_scm import get_version
          v = get_version()
          print("Computed version:", v)
          if ".dev" not in v:
              raise SystemExit(f"Refusing to publish non-dev version to Test PyPI: {v}")
          PY

      - name: Publish package to Test PyPI
        if: success()
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          python -m pip install --upgrade twine
          python -m pip install -U packaging
          python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*
